<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP SSE Client Example</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue',
          Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      h1 {
        color: #333;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .status.connected {
        background-color: #d4edda;
        color: #155724;
      }

      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }

      .status.reconnecting {
        background-color: #fff3cd;
        color: #856404;
      }

      .controls {
        margin-bottom: 15px;
      }

      button {
        padding: 10px 20px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .event-log {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background-color: #f8f9fa;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }

      .event {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 4px;
        word-wrap: break-word;
      }

      .event.connected {
        background-color: #d1ecf1;
        border-left: 3px solid #0c5460;
      }

      .event.auth-status {
        background-color: #d4edda;
        border-left: 3px solid #155724;
      }

      .event.conversation-update {
        background-color: #cce5ff;
        border-left: 3px solid #004085;
      }

      .event.tool-response {
        background-color: #e2e3e5;
        border-left: 3px solid #383d41;
      }

      .event.heartbeat {
        background-color: #f8f9fa;
        border-left: 3px solid #6c757d;
      }

      .event.error {
        background-color: #f8d7da;
        border-left: 3px solid #721c24;
      }

      .event-type {
        font-weight: bold;
        color: #333;
      }

      .event-time {
        color: #666;
        font-size: 11px;
      }

      .event-data {
        margin-top: 5px;
        color: #555;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .stat {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #007bff;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h1>MCP SSE Client Example</h1>

    <div class="container">
      <h2>Connection Status</h2>
      <div id="status" class="status disconnected">Disconnected</div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        <button id="clearLogBtn" onclick="clearLog()">Clear Log</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Events Received</div>
          <div class="stat-value" id="eventCount">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Reconnect Attempts</div>
          <div class="stat-value" id="reconnectAttempts">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Connection Time</div>
          <div class="stat-value" id="connectionTime">--</div>
        </div>
      </div>
    </div>

    <div class="container">
      <h2>Event Log</h2>
      <div id="eventLog" class="event-log"></div>
    </div>

    <script src="../src/client/sse-client.browser.js"></script>
    <script>
      let client = null;
      let eventCount = 0;
      let connectionStartTime = null;
      let connectionTimeInterval = null;

      // SSE endpoint URL (adjust as needed)
      const SSE_URL = 'http://localhost:3000/mcp/stream';

      function updateStatus(status, message) {
        const statusEl = document.getElementById('status');
        statusEl.className = `status ${status}`;
        statusEl.textContent = message;
      }

      function updateReconnectAttempts() {
        if (client) {
          document.getElementById('reconnectAttempts').textContent =
            client.getReconnectAttempts();
        }
      }

      function updateConnectionTime() {
        if (connectionStartTime) {
          const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('connectionTime').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        } else {
          document.getElementById('connectionTime').textContent = '--';
        }
      }

      function logEvent(eventType, data) {
        eventCount++;
        document.getElementById('eventCount').textContent = eventCount;

        const logEl = document.getElementById('eventLog');
        const eventEl = document.createElement('div');
        eventEl.className = `event ${eventType}`;

        const time = new Date().toLocaleTimeString();
        const dataStr = JSON.stringify(data, null, 2);

        eventEl.innerHTML = `
          <div class="event-type">${eventType}</div>
          <div class="event-time">${time}</div>
          <div class="event-data"><pre>${dataStr}</pre></div>
        `;

        logEl.appendChild(eventEl);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function clearLog() {
        document.getElementById('eventLog').innerHTML = '';
        eventCount = 0;
        document.getElementById('eventCount').textContent = '0';
      }

      function connect() {
        if (client) {
          console.log('Already connected');
          return;
        }

        // Create SSE client
        client = createSSEClient(SSE_URL, {
          initialReconnectDelay: 1000,
          maxReconnectDelay: 30000,
          reconnectDecayRate: 1.5,
          maxReconnectAttempts: 10,
          withCredentials: true,
        });

        // Setup event handlers
        client.onConnect(() => {
          console.log('Connected!');
          updateStatus('connected', 'Connected to SSE stream');
          connectionStartTime = Date.now();
          connectionTimeInterval = setInterval(updateConnectionTime, 1000);
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('disconnectBtn').disabled = false;
        });

        client.onDisconnect(() => {
          console.log('Disconnected');
          updateStatus('reconnecting', 'Reconnecting...');
          updateReconnectAttempts();
          if (connectionTimeInterval) {
            clearInterval(connectionTimeInterval);
            connectionTimeInterval = null;
          }
        });

        client.onError((error) => {
          console.error('SSE Error:', error);
          logEvent('error', { message: error.message });
        });

        // Listen to specific event types
        client.on('connected', (data) => {
          console.log('Connected event:', data);
          logEvent('connected', data);
        });

        client.on('auth-status', (data) => {
          console.log('Auth status:', data);
          logEvent('auth-status', data);
        });

        client.on('conversation-update', (data) => {
          console.log('Conversation update:', data);
          logEvent('conversation-update', data);
        });

        client.on('tool-response', (data) => {
          console.log('Tool response:', data);
          logEvent('tool-response', data);
        });

        client.on('heartbeat', (data) => {
          console.log('Heartbeat:', data);
          logEvent('heartbeat', data);
        });

        client.on('error', (data) => {
          console.error('Error event:', data);
          logEvent('error', data);
        });

        // Connect
        updateStatus('reconnecting', 'Connecting...');
        client.connect();
      }

      function disconnect() {
        if (client) {
          client.close();
          client = null;
          updateStatus('disconnected', 'Disconnected');
          connectionStartTime = null;
          if (connectionTimeInterval) {
            clearInterval(connectionTimeInterval);
            connectionTimeInterval = null;
          }
          updateConnectionTime();
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('reconnectAttempts').textContent = '0';
        }
      }

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (client) {
          client.close();
        }
      });
    </script>
  </body>
</html>
